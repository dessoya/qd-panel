config={qd:{port:11E3,host:"qd-panel.spacecraft-online.org"},auth:{cookie:"qdauth"}};
!function(x){function l(b,g){var a=(65535&b)+(65535&g);return(b>>16)+(g>>16)+(a>>16)<<16|65535&a}function k(b,g,a,k,h,j){b=l(l(g,b),l(k,j));return l(b<<h|b>>>32-h,a)}function h(b,g,a,h,j,i,m){return k(g&a|~g&h,b,g,j,i,m)}function j(b,g,a,h,j,i,m){return k(g&h|a&~h,b,g,j,i,m)}function i(b,g,a,h,j,i,m){return k(a^(g|~h),b,g,j,i,m)}function n(b,g){b[g>>5]|=128<<g%32;b[(g+64>>>9<<4)+14]=g;var a,p,q,r,m,c=1732584193,d=-271733879,e=-1732584194,f=271733878;for(a=0;a<b.length;a+=16)p=c,q=d,r=e,m=f,c=h(c,
d,e,f,b[a],7,-680876936),f=h(f,c,d,e,b[a+1],12,-389564586),e=h(e,f,c,d,b[a+2],17,606105819),d=h(d,e,f,c,b[a+3],22,-1044525330),c=h(c,d,e,f,b[a+4],7,-176418897),f=h(f,c,d,e,b[a+5],12,1200080426),e=h(e,f,c,d,b[a+6],17,-1473231341),d=h(d,e,f,c,b[a+7],22,-45705983),c=h(c,d,e,f,b[a+8],7,1770035416),f=h(f,c,d,e,b[a+9],12,-1958414417),e=h(e,f,c,d,b[a+10],17,-42063),d=h(d,e,f,c,b[a+11],22,-1990404162),c=h(c,d,e,f,b[a+12],7,1804603682),f=h(f,c,d,e,b[a+13],12,-40341101),e=h(e,f,c,d,b[a+14],17,-1502002290),
d=h(d,e,f,c,b[a+15],22,1236535329),c=j(c,d,e,f,b[a+1],5,-165796510),f=j(f,c,d,e,b[a+6],9,-1069501632),e=j(e,f,c,d,b[a+11],14,643717713),d=j(d,e,f,c,b[a],20,-373897302),c=j(c,d,e,f,b[a+5],5,-701558691),f=j(f,c,d,e,b[a+10],9,38016083),e=j(e,f,c,d,b[a+15],14,-660478335),d=j(d,e,f,c,b[a+4],20,-405537848),c=j(c,d,e,f,b[a+9],5,568446438),f=j(f,c,d,e,b[a+14],9,-1019803690),e=j(e,f,c,d,b[a+3],14,-187363961),d=j(d,e,f,c,b[a+8],20,1163531501),c=j(c,d,e,f,b[a+13],5,-1444681467),f=j(f,c,d,e,b[a+2],9,-51403784),
e=j(e,f,c,d,b[a+7],14,1735328473),d=j(d,e,f,c,b[a+12],20,-1926607734),c=k(d^e^f,c,d,b[a+5],4,-378558),f=k(c^d^e,f,c,b[a+8],11,-2022574463),e=k(f^c^d,e,f,b[a+11],16,1839030562),d=k(e^f^c,d,e,b[a+14],23,-35309556),c=k(d^e^f,c,d,b[a+1],4,-1530992060),f=k(c^d^e,f,c,b[a+4],11,1272893353),e=k(f^c^d,e,f,b[a+7],16,-155497632),d=k(e^f^c,d,e,b[a+10],23,-1094730640),c=k(d^e^f,c,d,b[a+13],4,681279174),f=k(c^d^e,f,c,b[a],11,-358537222),e=k(f^c^d,e,f,b[a+3],16,-722521979),d=k(e^f^c,d,e,b[a+6],23,76029189),c=k(d^
e^f,c,d,b[a+9],4,-640364487),f=k(c^d^e,f,c,b[a+12],11,-421815835),e=k(f^c^d,e,f,b[a+15],16,530742520),d=k(e^f^c,d,e,b[a+2],23,-995338651),c=i(c,d,e,f,b[a],6,-198630844),f=i(f,c,d,e,b[a+7],10,1126891415),e=i(e,f,c,d,b[a+14],15,-1416354905),d=i(d,e,f,c,b[a+5],21,-57434055),c=i(c,d,e,f,b[a+12],6,1700485571),f=i(f,c,d,e,b[a+3],10,-1894986606),e=i(e,f,c,d,b[a+10],15,-1051523),d=i(d,e,f,c,b[a+1],21,-2054922799),c=i(c,d,e,f,b[a+8],6,1873313359),f=i(f,c,d,e,b[a+15],10,-30611744),e=i(e,f,c,d,b[a+6],15,-1560198380),
d=i(d,e,f,c,b[a+13],21,1309151649),c=i(c,d,e,f,b[a+4],6,-145523070),f=i(f,c,d,e,b[a+11],10,-1120210379),e=i(e,f,c,d,b[a+2],15,718787259),d=i(d,e,f,c,b[a+9],21,-343485551),c=l(c,p),d=l(d,q),e=l(e,r),f=l(f,m);return[c,d,e,f]}function s(b){var g,a="";for(g=0;g<32*b.length;g+=8)a+=String.fromCharCode(b[g>>5]>>>g%32&255);return a}function o(b){var g,a=[];a[(b.length>>2)-1]=void 0;for(g=0;g<a.length;g+=1)a[g]=0;for(g=0;g<8*b.length;g+=8)a[g>>5]|=(255&b.charCodeAt(g/8))<<g%32;return a}function t(b){var g,
a,h="";for(a=0;a<b.length;a+=1)g=b.charCodeAt(a),h+="0123456789abcdef".charAt(g>>>4&15)+"0123456789abcdef".charAt(15&g);return h}function u(b){b=unescape(encodeURIComponent(b));return s(n(o(b),8*b.length))}function v(b,g){var a=unescape(encodeURIComponent(b)),h=unescape(encodeURIComponent(g)),j,i=o(a),k=[],c=[];k[15]=c[15]=void 0;16<i.length&&(i=n(i,8*a.length));for(a=0;16>a;a+=1)k[a]=909522486^i[a],c[a]=1549556828^i[a];return j=n(k.concat(o(h)),512+8*h.length),s(n(c.concat(j),640))}function w(b,
g,a){return g?a?v(g,b):t(v(g,b)):a?u(b):t(u(b))}"function"==typeof define&&define.amd?define(function(){return w}):x.md5=w}(this);
(function(h){function k(a){return a}function l(a){return decodeURIComponent(a.replace(m," "))}function i(a){0===a.indexOf('"')&&(a=a.slice(1,-1).replace(/\\"/g,'"').replace(/\\\\/g,"\\"));try{return d.json?JSON.parse(a):a}catch(c){}}var m=/\+/g,d=h.cookie=function(a,c,b){if(void 0!==c){if("number"===typeof b.expires){var f=b.expires,e=b.expires=new Date;e.setDate(e.getDate()+f)}c=d.json?JSON.stringify(c):String(c);return document.cookie=[d.raw?a:encodeURIComponent(a),"=",d.raw?c:encodeURIComponent(c),
b.expires?"; expires="+b.expires.toUTCString():"",b.path?"; path="+b.path:"",b.domain?"; domain="+b.domain:"",b.secure?"; secure":""].join("")}for(var c=d.raw?k:l,b=document.cookie.split("; "),f=a?void 0:{},e=0,h=b.length;e<h;e++){var g=b[e].split("="),j=c(g.shift()),g=c(g.join("="));if(a&&a===j){f=i(g);break}a||(f[j]=i(g))}return f};d.defaults={}})(window);
var Class=function(){};
Class.prototype={onCreate:function(){},inherit:function(){var a=arguments[0],f=Array.prototype.slice.call(arguments,0);f.push(this);var c=function(){},b=c.prototype={};b.parent=this.prototype;b.parents=[];a.global?(b.global="function"===typeof a.global?a.global():a.global,delete a.global):b.global={};for(var g=f.length;g--;){var d=f[g];"function"==typeof d&&(d=d.prototype,b.parents.push(d));for(var e in d)"parent"==e||("parents"==e||"global"==e)||(b[e]=d[e])}c.global=b.global;c.create=this.create;
c.inherit=this.inherit;c.asParent=this.asParent;if(a.globalInterface)for(e in a.globalInterface)c[e]=a.globalInterface[e];return c},asParent:function(a,f){return!f?this.prototype.parent.onCreate.bind(a):this.prototype.parent[f].bind(a)},create:function(){var a=new this;a.global=this.prototype.global;a.onCreate.apply(a,arguments);return a},defineProps:function(a){for(var a=a.split(","),f={},c=a.length;c--;){for(var b=a[c].split(":"),g=b[0],d=1,e=b.length;d<e;d++)this["propMaker_"+b[d]](g);f[g]={get:this["get_"+
g],set:this["set_"+g]}}Object.defineProperties(this,f)}};Class=Class.prototype.inherit({});
AJAX=Class.inherit({onCreate:function(a){this.prop=a;this.ctx=a.ctx;this.type=a.type;this.onSuccess=a.success;this.req=new XMLHttpRequest;this.req.onreadystatechange=this.onRequest.bind(this);var b=a.url,c=[],d;for(d in a.params)c.push(d+"="+encodeURIComponent(a.params[d]));c.length&&(b+="?"+c.join("&"));a.post?(this.method="POST",a=JSON.parse(a.post),a.session_hash=session_hash,this.request=JSON.stringify(a)):(this.method="POST",this.request=JSON.stringify({session_hash:session_hash}));this.url=
b;this.req.open(this.method,b,!0);this.req.send(this.request)},onRequest:function(){if(4==this.req.readyState&&0==this.req.status)this.onSuccess(null,this.ctx);if(4==this.req.readyState)if(200==this.req.status){var a=this.req.responseText;if("json"==this.type){var b;try{b=JSON.parse(a)}catch(c){try{b=eval("("+a+")")}catch(d){b=null}}a=b;if("error"===a.status&&"not logged"===a.error){var e=this.prop;auth.show(function(){AJAX.create(e)});return}}this.onSuccess(a,this.ctx)}else this.onSuccess(null,this.ctx)}});
Auth=Class.inherit({onCreate:function(){},init:function(a){a.innerHTML+='<div id="cont_auth" style="opacity: 0.8; background: #444; position:absolute; top:0px; left:0px; right:0px; bottom:0px; display:none"><div style="box-shadow: 0px 0px 10px #fff; margin:50px auto; width:220px; background: #fff; border: 1px solid black; border-radius: 4px 4px 4px 4px; padding: 6px 10px"><div style="margin-bottom: 3px"><div class="fl w70" style="line-height:24px; height: 24px">login</div><input id="input_login_" class="fl w150" type="text" /><div class="cb"></div></div><div style="margin-bottom: 8px"><div class="fl w70" style="line-height:24px; height: 24px">password</div><input onkeydown="auth.onkeydown(event)" id="input_password" class="fl w150" type="password" /><div class="cb"></div></div><button id="button_login" style="width: 100%" onclick="auth.login()">login</button></div></div>'},
show:function(a){a&&(this.callback=a);cont_auth.style.display="block";button_login.removeAttribute("disabled");input_login_.value="";input_password.value=""},hide:function(){cont_auth.style.display="none"},login:function(){var a={login:input_login_.value,password_hash:md5(input_password.value)};button_login.setAttribute("disabled","disabled");AJAX.create({type:"json",post:JSON.stringify(a),url:"http://"+config.qd.host+":"+config.qd.port+"/auth/login",success:function(a){"ok"===a.status?a.result.auth?
(auth.hide(),session_hash=a.result.session_hash,cookie(config.auth.cookie,session_hash,{expires:2,path:"/"}),this.callback?(a=this.callback,delete this.callback,a()):sections.start(!0)):(alert("wrong login or password !"),button_login.removeAttribute("disabled"),input_login_.value="",input_password.value="",input_login_.focus()):console.log("error")}.bind(this)})},onkeydown:function(a){13===a.which&&this.login()},logout:function(){AJAX.create({type:"json",url:"http://"+config.qd.host+":"+config.qd.port+
"/auth/logout",success:function(){auth.show()}})}});auth=Auth.create();
Sections=Class.inherit({onCreate:function(){this.sections={};this.re_sections=[];this.all=[]},addSection:function(b){this.all.push(b);var a=b.pattern;if(-1!==a.indexOf("*")){var c=0;do{var d=a.indexOf("*");-1!==d&&(c++,a=a.substr(0,d)+"([a-z\\-\\d]+?)"+a.substr(d+1))}while(-1!==d);this.re_sections.push({re:RegExp("^"+a+"$"),count:c,section:b})}else this.sections[a]=b},find:function(b){for(var a=this.re_sections,c=a.length;c--;){var d=a[c],e;if(e=d.re.exec(b)){b=[];a=0;for(c=d.count;a<c;a++)b.push(e[a+
1]);return{section:d.section,params:b}}}return null},check:function(b){return b in this.sections||this.find(b)?!0:!1},activate:function(b,a){if(a||this.sectionName!==b){this.sectionName=b;var c=null;if(b in this.sections)c=this.sectionName in this.sections?this.sections[this.sectionName]:null;else{var c=this.find(b),d=[];c&&(d=c.params,c=c.section)}this.section&&this.section.deactivate&&this.section.deactivate();(window.section=this.section=c)&&c.activate(d)}},start:function(b){for(var a=this.all.length;a--;){var c=
this.all[a];c.start&&c.start()}window.onhashchange(b)}});sections=Sections.create();window.onhashchange=function(b){var a=window.location.hash;0<a.length&&"#"===a[0]&&(a=a.substr(1));sections.check(a)||(a="main",window.location.hash="");sections.activate(a,b)};
BreadCrumbs=Class.inherit({onCreate:function(){this.path=[]},place:function(a){a&&(this.selector=a);a=this.render();document.querySelector(this.selector).innerHTML=a},render:function(){var a;a="<div>";for(var b=0,c=this.path,d=c.length,e=d-1;b<d;b++)a+='<a href="#'+c[b].href+'" class="fl rm5">'+c[b].title+"</a>",b!=e&&(a+='<div class="fl rm5">-></div>');return a+'<div class="fl w5">&nbsp;</div><div class="cb"></div></div><br>'},setup:function(a){this.path=a;this.place()}});
Sections.QServers=Class.inherit({pattern:"main",onCreate:function(){},start:function(){},activate:function(){breadCrumbs.setup([{href:"qservers",title:"quote servers"}]);cont_main.innerHTML=""},deactivate:function(){}});sections.addSection(Sections.QServers.create());
Sections.Bridge=Class.inherit({pattern:"bridge",onCreate:function(){},start:function(){},activate:function(){breadCrumbs.setup([{href:"bridge",title:"bridge"}]);cont_main.innerHTML='<div><a href="#bridge/bb_rules">bb_rules</a></div><div><a href="#bridge/cls_rules">cls_rules</a></div>'},deactivate:function(){}});sections.addSection(Sections.Bridge.create());
var sheet=function(){var a=document.createElement("style");a.appendChild(document.createTextNode(""));document.head.appendChild(a);return a.sheet}();function addCSSRule(a,b,c,d){"insertRule"in a?a.insertRule(b+"{"+c+"}",d):"addRule"in a&&a.addRule(b,c,d)}
Sections.Bridge.BBRUles=Class.inherit({re_login:/^\d+$/,pattern:"bridge/bb_rules",onCreate:function(){this.binded_onRulesHintLoaded=this.onRulesHintLoaded.bind(this);this.binded_onRulesLoaded=this.onRulesLoaded.bind(this);this.binded_onRuleAdded=this.onRuleAdded.bind(this);this.binded_onRuleDeleted=this.onRuleDeleted.bind(this);this.canvas1=document.createElement("canvas");this.canvas1.width=24;this.canvas1.height=18;this.ctx1=this.canvas1.getContext("2d");this.imd=this.ctx1.createImageData(1,1);
this.imd.data[0]=0;this.imd.data[1]=0;this.imd.data[2]=0;this.imd.data[3]=255;this.ctx1.fillStyle="rgba(255,255,255,0)";this.ctx1.fillRect(0,0,24,18);for(var a=0;9>a;a++)this.ctx1.putImageData(this.imd,12,a);for(a=12;24>a;a++)this.ctx1.putImageData(this.imd,a,9);addCSSRule(sheet,".img1","background-image: url("+this.canvas1.toDataURL("image/x-icon")+"); background-repeat: no-repeat",0);this.canvas2=document.createElement("canvas");this.canvas2.width=24;this.canvas2.height=18;this.ctx2=this.canvas2.getContext("2d");
this.ctx2.fillStyle="rgba(255,255,255,0)";this.ctx2.fillRect(0,0,24,18);for(a=0;18>a;a++)this.ctx2.putImageData(this.imd,12,a);for(a=12;24>a;a++)this.ctx2.putImageData(this.imd,a,9);addCSSRule(sheet,".img2","background-image: url("+this.canvas2.toDataURL("image/x-icon")+"); background-repeat: no-repeat",1);this.canvas3=document.createElement("canvas");this.canvas3.width=24;this.canvas3.height=18;this.ctx3=this.canvas3.getContext("2d");this.ctx3.fillStyle="rgba(255,255,255,0)";this.ctx3.fillRect(0,
0,24,18);for(a=0;18>a;a++)this.ctx3.putImageData(this.imd,12,a);addCSSRule(sheet,".img3","background-image: url("+this.canvas3.toDataURL("image/x-icon")+"); background-repeat: no-repeat",2)},start:function(){},activate:function(){breadCrumbs.setup([{href:"bridge",title:"bridge"},{href:"bridge/bb_rules",title:"bb_rules"}]);cont_main.innerHTML='<div id="cont_rules_tree"></div><br><div id="cont_common_add"></div>';AJAX.create({type:"json",url:"http://"+config.qd.host+":"+config.qd.port+"/rules/hint",
success:this.binded_onRulesHintLoaded})},deactivate:function(){},onRulesLoaded:function(a){for(var b=a.result.rules,a=[],c={},d=0,f=b.length;d<f;d++){var e=b[d],g=e.source_id,h;g in c?h=c[g]:(h={source_id:g,logins:[],logins_map:{}},c[g]=h,a.push(h));g=e.login?e.login:e.group;g in h.logins_map?g=h.logins_map[g]:(h.logins_map[g]={login:g,rules:[]},g=h.logins_map[g],h.logins.push(g));h={operation_event_id:e.operation_event_id,symbol_template_id:e.symbol_template_id,id:e.id};e.feedor_id&&(h.feedor_id=
e.feedor_id);g.rules.push(h)}b="";d=0;for(f=a.length;d<f;d++)b+=this.renderSourceLevel(a[d]);cont_rules_tree.innerHTML=b},getSourceName:function(a){if(!("sources"in this.resources)){for(var b={},c=0,d=this.hints.sources,f=d.length;c<f;c++){var e=d[c];b[e.id]=e}this.resources.sources=b}return this.resources.sources[a].name},getOperation:function(a){if(!("operations"in this.resources)){for(var b={},c=0,d=this.hints.operations,f=d.length;c<f;c++){var e=d[c];b[e.id]=e}this.resources.operations=b}return this.resources.operations[a]},
getTemplate:function(a){if(!("templates"in this.resources)){for(var b={},c=0,d=this.hints.templates,f=d.length;c<f;c++){var e=d[c];b[e.id]=e}this.resources.templates=b}return a in this.resources.templates?this.resources.templates[a]:{id:0,name:""}},getFeedor:function(a){if(!("feedors"in this.resources)){for(var b={},c=0,d=this.hints.feedors,f=d.length;c<f;c++){var e=d[c];b[e.id]=e}this.resources.feedors=b}return a in this.resources.feedors?this.resources.feedors[a]:{id:0,name:""}},renderSourceLevel:function(a){var b;
b="<div>"+('<div class="fl h18 w200">source: <b>'+this.getSourceName(a.source_id)+"</b></div>");b+='<div class="cb"></div></div>';for(var c=0,a=a.logins,d=a.length,f=d-1;c<d;c++)b+=this.renderLoginLevel(a[c],c==f);return b+"<br>"},renderLoginLevel:function(a,b){var c;c="<div>"+('<div class="fl h18 w24 '+(b?"img1":"img2")+'">&nbsp;</div>')+('<div class="fl h18 w100">'+(this.re_login.exec(a.login)?"login":"group")+": <b>"+a.login+"</b></div>");c+='<div class="cb"></div></div>';for(var d=0,f=a.rules,
e=f.length,g=e-1;d<e;d++)c+=this.renderRuleLevel(f[d],b,d==g);return c},renderRuleLevel:function(a,b,c){b="<div>"+('<div class="fl h18 w24 '+(b?"":"img3")+'">&nbsp;</div>')+('<div class="fl h18 w24 '+(c?"img1":"img2")+'">&nbsp;</div>')+('<div class="fl h18 w100">'+this.getOperation(a.operation_event_id).name+"</div>");b+='<div class="fl h18 w100">'+this.getTemplate(a.symbol_template_id).name+"</div>";b+='<div class="fl h18 w100">-> '+this.getFeedor(a.feedor_id).name+"</div>";b=b+'<div class="fl h18 w100">'+
('<a href="javascript:section.delRule('+a.id+')">del</a>');return b+'</div><div class="cb"></div></div>'},onRulesHintLoaded:function(a){this.hints=a.result;this.resources={};var b;b='<div><div class="fl w150 rm5">&nbsp;source</div><div class="fl w150 rm5">&nbsp;</div><div class="fl w150 rm5">&nbsp;operation</div><div class="fl w150 rm5">&nbsp;template</div><div class="fl w150 rm5">&nbsp;feedor</div><div class="cb"></div></div><div><select onchange="section.commonAddChanger()" class="fl w150 rm5" id="input_source"><option value="0" selected="selected">*required*</option>';
for(var c=0,d=a.result.sources,f=d.length;c<f;c++){var e=d[c];b+='<option value="'+e.id+'">'+e.name+"</option>"}b+='</select><input onkeyup="section.commonAddChanger()" class="fl w150 rm5" type="text" placeholder="login or group" id="input_login" /><select class="fl w150 rm5" id="input_operation_event">';c=0;d=a.result.operations;for(f=d.length;c<f;c++)e=d[c],b+="<option "+(0==c?'selected="selected" ':"")+'value="'+e.id+'">'+e.name+"</option>";b+='</select><select onchange="section.commonAddChanger()" class="fl w150 rm5" id="input_template"><option value="0" selected="selected">*required*</option>';
c=0;d=a.result.templates;for(f=d.length;c<f;c++)e=d[c],b+='<option value="'+e.id+'">'+e.name+"</option>";b+='</select><select class="fl w150 rm5" id="input_feedor"><option value="0" selected="selected">absent</option>';c=0;d=a.result.feedors;for(f=d.length;c<f;c++)a=d[c],b+='<option value="'+a.id+'">'+a.name+"</option>";cont_common_add.innerHTML=b+'</select><button disabled="disabled" class="fl w5" id="control_common_add" onclick="section.addCommonTemplate()">add</button><div class="cb"></div></div>';
this.loadRules()},loadRules:function(){AJAX.create({type:"json",post:JSON.stringify({rule_type:"bb"}),url:"http://"+config.qd.host+":"+config.qd.port+"/rules/get",success:this.binded_onRulesLoaded})},commonAddChanger:function(){"0"!=input_source.value&&0<input_login.value.length&&"0"!=input_template.value?control_common_add.removeAttribute("disabled"):control_common_add.setAttribute("disabled","disabled")},addCommonTemplate:function(){var a={sync:!0,rule_type:"bb",source_id:input_source.value,operation_event_id:input_operation_event.value,
symbol_template_id:input_template.value};"0"!=input_feedor.value&&(a.feedor_id=input_feedor.value);this.re_login.exec(input_login.value)?a.login=input_login.value:a.group=input_login.value;input_source.value="0";input_login.value="";input_operation_event.value="0";input_template.value="0";input_feedor.value="0";control_common_add.setAttribute("disabled","disabled");AJAX.create({type:"json",post:JSON.stringify(a),url:"http://"+config.qd.host+":"+config.qd.port+"/rules/add",success:this.binded_onRuleAdded})},
onRuleAdded:function(){this.loadRules()},delRule:function(a){AJAX.create({type:"json",post:JSON.stringify({rule_id:a,sync:!0}),url:"http://"+config.qd.host+":"+config.qd.port+"/rules/del",success:this.binded_onRuleDeleted})},onRuleDeleted:function(){this.loadRules()}});sections.addSection(Sections.Bridge.BBRUles.create());
Sections.Bridge.ClassicRules=Class.inherit({re_login:/^\d+$/,pattern:"bridge/cls_rules",onCreate:function(){this.binded_onRulesHintLoaded=this.onRulesHintLoaded.bind(this);this.binded_onRulesLoaded=this.onRulesLoaded.bind(this);this.binded_onRuleAdded=this.onRuleAdded.bind(this);this.binded_onRuleDeleted=this.onRuleDeleted.bind(this)},start:function(){},activate:function(){breadCrumbs.setup([{href:"bridge",title:"bridge"},{href:"bridge/cls_rules",title:"cls_rules"}]);cont_main.innerHTML='<div id="cont_rules_tree"></div><br><div id="cont_common_add"></div>';
AJAX.create({type:"json",url:"http://"+config.qd.host+":"+config.qd.port+"/rules/hint",success:this.binded_onRulesHintLoaded})},deactivate:function(){},onRulesLoaded:function(c){for(var a=c.result.rules,c=[],b={},d=0,f=a.length;d<f;d++){var e=a[d],g=e.source_id,h;g in b?h=b[g]:(h={source_id:g,logins:[],logins_map:{}},b[g]=h,c.push(h));g=e.login?e.login:e.group;g in h.logins_map?g=h.logins_map[g]:(h.logins_map[g]={login:g,rules:[]},g=h.logins_map[g],h.logins.push(g));h={operation_event_id:e.operation_event_id,
symbol_template_id:e.symbol_template_id,target_id:e.target_id,id:e.id};e.feedor_id&&(h.feedor_id=e.feedor_id);g.rules.push(h)}a="";d=0;for(f=c.length;d<f;d++)a+=this.renderSourceLevel(c[d]);cont_rules_tree.innerHTML=a},getSourceName:function(c){if(!("sources"in this.resources)){for(var a={},b=0,d=this.hints.sources,f=d.length;b<f;b++){var e=d[b];a[e.id]=e}this.resources.sources=a}return c in this.resources.sources?this.resources.sources[c].name:""},getOperation:function(c){if(!("operations"in this.resources)){for(var a=
{},b=0,d=this.hints.operations,f=d.length;b<f;b++){var e=d[b];a[e.id]=e}this.resources.operations=a}return this.resources.operations[c]},getTemplate:function(c){if(!("templates"in this.resources)){for(var a={},b=0,d=this.hints.templates,f=d.length;b<f;b++){var e=d[b];a[e.id]=e}this.resources.templates=a}return c in this.resources.templates?this.resources.templates[c]:{id:0,name:""}},getFeedor:function(c){if(!("feedors"in this.resources)){for(var a={},b=0,d=this.hints.feedors,f=d.length;b<f;b++){var e=
d[b];a[e.id]=e}this.resources.feedors=a}return c in this.resources.feedors?this.resources.feedors[c]:{id:0,name:""}},getTarget:function(c){if(!("targets"in this.resources)){for(var a={},b=0,d=this.hints.targets,f=d.length;b<f;b++){var e=d[b];a[e.id]=e}this.resources.targets=a}return c in this.resources.targets?this.resources.targets[c]:{id:0,name:""}},renderSourceLevel:function(c){var a;a="<div>"+('<div class="fl h18 w200">source: <b>'+this.getSourceName(c.source_id)+"</b></div>");a+='<div class="cb"></div></div>';
for(var b=0,c=c.logins,d=c.length,f=d-1;b<d;b++)a+=this.renderLoginLevel(c[b],b==f);return a+"<br>"},renderLoginLevel:function(c,a){var b;b="<div>"+('<div class="fl h18 w24 '+(a?"img1":"img2")+'">&nbsp;</div>')+('<div class="fl h18 w150">'+(this.re_login.exec(c.login)?"login":"group")+": <b>"+c.login+"</b></div>");b+='<div class="cb"></div></div>';for(var d=0,f=c.rules,e=f.length,g=e-1;d<e;d++)b+=this.renderRuleLevel(f[d],a,d==g);return b},renderRuleLevel:function(c,a,b){a="<div>"+('<div class="fl h18 w24 '+
(a?"":"img3")+'">&nbsp;</div>')+('<div class="fl h18 w24 '+(b?"img1":"img2")+'">&nbsp;</div>')+('<div class="fl h18 w100">'+this.getOperation(c.operation_event_id).name+"</div>");a+='<div class="fl h18 w100">'+this.getTemplate(c.symbol_template_id).name+"</div>";a+='<div class="fl h18 w150">-> '+this.getTarget(c.target_id).name+"</div>";a+='<div class="fl h18 w100">'+this.getFeedor(c.feedor_id).name+"</div>";a=a+'<div class="fl h18 w100">'+('<a href="javascript:section.delRule('+c.id+')">del</a>');
return a+'</div><div class="cb"></div></div>'},onRulesHintLoaded:function(c){this.hints=c.result;this.resources={};var a;a='<div><div class="fl w150 rm5">&nbsp;source</div><div class="fl w150 rm5">&nbsp;</div><div class="fl w150 rm5">&nbsp;operation</div><div class="fl w150 rm5">&nbsp;template</div><div class="fl w150 rm5">&nbsp;target</div><div class="fl w150 rm5">&nbsp;feedor</div><div class="cb"></div></div><div><select onchange="section.commonAddChanger()" class="fl w150 rm5" id="input_source"><option value="0" selected="selected">*required*</option>';
for(var b=0,d=c.result.sources,f=d.length;b<f;b++){var e=d[b];a+='<option value="'+e.id+'">'+e.name+"</option>"}a+='</select><input onkeyup="section.commonAddChanger()" class="fl w150 rm5" type="text" placeholder="login or group" id="input_login" /><select class="fl w150 rm5" id="input_operation_event">';b=0;d=c.result.operations;for(f=d.length;b<f;b++)e=d[b],a+="<option "+(0==b?'selected="selected" ':"")+'value="'+e.id+'">'+e.name+"</option>";a+='</select><select onchange="section.commonAddChanger()" class="fl w150 rm5" id="input_template"><option value="0" selected="selected">*required*</option>';
b=0;d=c.result.templates;for(f=d.length;b<f;b++)e=d[b],a+='<option value="'+e.id+'">'+e.name+"</option>";a+='</select><select onchange="section.commonAddChanger()" class="fl w150 rm5" id="input_target"><option value="0" selected="selected">*required*</option>';b=0;d=c.result.targets;for(f=d.length;b<f;b++)e=d[b],a+='<option value="'+e.id+'">'+e.name+"</option>";a+='</select><select class="fl w150 rm5" id="input_feedor"><option value="0" selected="selected">absent</option>';b=0;d=c.result.feedors;
for(f=d.length;b<f;b++)c=d[b],a+='<option value="'+c.id+'">'+c.name+"</option>";cont_common_add.innerHTML=a+'</select><button disabled="disabled" class="fl w5" id="control_common_add" onclick="section.addCommonTemplate()">add</button><div class="cb"></div></div>';this.loadRules()},loadRules:function(){AJAX.create({type:"json",post:JSON.stringify({rule_type:"classic"}),url:"http://"+config.qd.host+":"+config.qd.port+"/rules/get",success:this.binded_onRulesLoaded})},commonAddChanger:function(){"0"!=
input_source.value&&0<input_login.value.length&&"0"!=input_template.value&&"0"!=input_target.value?control_common_add.removeAttribute("disabled"):control_common_add.setAttribute("disabled","disabled")},addCommonTemplate:function(){var c={sync:!0,rule_type:"classic",source_id:input_source.value,operation_event_id:input_operation_event.value,symbol_template_id:input_template.value,target_id:input_target.value};"0"!=input_feedor.value&&(c.feedor_id=input_feedor.value);this.re_login.exec(input_login.value)?
c.login=input_login.value:c.group=input_login.value;input_source.value="0";input_login.value="";input_operation_event.value="0";input_template.value="0";input_target.value="0";input_feedor.value="0";control_common_add.setAttribute("disabled","disabled");AJAX.create({type:"json",post:JSON.stringify(c),url:"http://"+config.qd.host+":"+config.qd.port+"/rules/add",success:this.binded_onRuleAdded})},onRuleAdded:function(){this.loadRules()},delRule:function(c){AJAX.create({type:"json",post:JSON.stringify({rule_id:c,
sync:!0}),url:"http://"+config.qd.host+":"+config.qd.port+"/rules/del",success:this.binded_onRuleDeleted})},onRuleDeleted:function(){this.loadRules()}});sections.addSection(Sections.Bridge.ClassicRules.create());
Sections.TemplatesList=Class.inherit({pattern:"templates/list",onCreate:function(){this.binded_onLoadTemplates=this.onLoadTemplates.bind(this);this.binded_onTemplateAdded=this.onTemplateAdded.bind(this);this.binded_onTemplateDeleted=this.onTemplateDeleted.bind(this)},start:function(){},activate:function(){breadCrumbs.setup([{href:"templates/list",title:"templates"},{href:"templates/list",title:"list"}]);cont_main.innerHTML='<div class="row"><div class="fl w50 header cell">id</div><div class="fl w100 header cell">name</div><div class="fl w50 header lastcell">rules</div><div class="cb"></div></div><div id="cont_templates"></div><br><div><input class="fl w150" id="input_st_name" type="text"/><div class="fl w10">&nbsp;</div><button class="fl w5" onclick="section.addTemplate()">add</button><div class="cb"></div></div>';
this.loadList()},deactivate:function(){},loadList:function(){AJAX.create({type:"json",url:"http://"+config.qd.host+":"+config.qd.port+"/symbol_templates/get",success:this.binded_onLoadTemplates})},onLoadTemplates:function(a){this.templates=a.result.list;this.renderList()},renderList:function(){for(var a="",c=0,d=this.templates.length,e=d-1;c<d;c++)var b=this.templates[c],a=a+('<div class="'+(c==e?"last":"")+'row">'),a=a+('<div class="fl w50 cell">'+b.id+"</div>"),a=a+('<div class="fl w100 cell">'+
b.name+"</div>"),a=a+('<div class="fl w50 cell">'+(b.rules_count?b.rules_count:0)+"</div>"),a=a+'<div class="fl w50 lastcell">',a=a+('<a href="javascript:section.delTemplate('+b.id+')">del</a>'),a=a+('<a href="#templates/'+b.id+'">edit</a>'),a=a+"</div>",a=a+'<div class="cb"></div>',a=a+"</div>";cont_templates.innerHTML=a},addTemplate:function(){var a={name:input_st_name.value,sync:!0};input_st_name.value="";AJAX.create({type:"json",post:JSON.stringify(a),url:"http://"+config.qd.host+":"+config.qd.port+
"/symbol_templates/add",success:this.binded_onTemplateAdded})},onTemplateAdded:function(a){a.result.access_denied?alert("access denied"):this.loadList()},delTemplate:function(a){AJAX.create({type:"json",post:JSON.stringify({id:a}),url:"http://"+config.qd.host+":"+config.qd.port+"/symbol_templates/del",success:this.binded_onTemplateDeleted})},onTemplateDeleted:function(){this.loadList()}});sections.addSection(Sections.TemplatesList.create());
Sections.TemplatesEdit=Class.inherit({pattern:"templates/*",onCreate:function(){this.binded_onLoadTemplaet=this.onLoadTemplaet.bind(this);this.binded_onTemplateSymbolsLoaded=this.onTemplateSymbolsLoaded.bind(this);this.binded_onSymbolAdded=this.onSymbolAdded.bind(this);this.binded_onSymbolDeleted=this.onSymbolDeleted.bind(this)},start:function(){},activate:function(b){this.id=b=b[0];breadCrumbs.setup([{href:"templates/list",title:"templates"},{href:"templates/"+b,title:b}]);cont_main.innerHTML="";
this.loadTemplate()},deactivate:function(){},addSymbol:function(){var b={symbol_template_id:this.id,symbol:input_symbol.value,echo_symbol:input_echo_symbol.value,factor:input_factor.value,bid_markup:input_bid_markup.value,ask_markup:input_ask_markup.value,price_left:input_price_left.value,price_right:input_price_right.value,timeout:input_timeout.value};input_symbol.value="";input_echo_symbol.value="";input_factor.value="";input_bid_markup.value="";input_ask_markup.value="";input_price_left.value=
"";input_price_right.value="";input_timeout.value="";AJAX.create({type:"json",post:JSON.stringify(b),url:"http://"+config.qd.host+":"+config.qd.port+"/symbol_templates/symbol/add",success:this.binded_onSymbolAdded})},onSymbolAdded:function(){this.loadTemplateSymbols()},loadTemplate:function(){AJAX.create({type:"json",post:JSON.stringify({id:this.id}),url:"http://"+config.qd.host+":"+config.qd.port+"/symbol_templates/get",success:this.binded_onLoadTemplaet})},onLoadTemplaet:function(b){b.result.access_denied?
cont_main.innerHTML="<b>access denied</b>":(this.template=b.result.symbol_template,this.renderTemplate(),this.loadTemplateSymbols())},renderTemplate:function(){breadCrumbs.setup([{href:"templates/list",title:"templates"},{href:"templates/"+this.id,title:"template "+this.template.name+"#"+this.id}]);cont_main.innerHTML='<div><div onclick="section.trigger(this)" id="trigger_field_bb" class="fl w70 rm5 trigger on">bb<div class="fr on">&#x02713;</div><div class="cb"></div></div><div onclick="section.trigger(this)" id="trigger_field_classic"  class="fl w70 rm5 trigger on">classic<div class="fr on">&#x02713;</div><div class="cb"></div></div><div class="cb"></div></div><br><div class="row"><div class="fl w80 header cell f_symbol">symbol</div><div class="fl w80 header cell f_echo_symbol">echo symbol</div><div class="fl w80 header cell f_factor">factor</div><div class="fl w80 header cell f_bid_markup">bid markup</div><div class="fl w80 header cell f_ask_markup">ask markup</div><div class="fl w80 header cell f_price_left">price left</div><div class="fl w80 header cell f_price_right">price right</div><div class="fl w80 header lastcell f_timeout">timeout</div><div class="cb"></div></div><div id="cont_symbols"></div><br><div><div class="fl w89 f_symbol"><input class="fl w80" id="input_symbol" type="text"/></div><div class="fl w89 f_echo_symbol"><input class="fl w80" id="input_echo_symbol" type="text"/></div><div class="fl w89 f_factor"><input class="fl w80" id="input_factor" type="text"/></div><div class="fl w89 f_bid_markup"><input class="fl w80" id="input_bid_markup" type="text"/></div><div class="fl w89 f_ask_markup"><input class="fl w80" id="input_ask_markup" type="text"/></div><div class="fl w89 f_price_left"><input class="fl w80" id="input_price_left" type="text"/></div><div class="fl w89 f_price_right"><input class="fl w80" id="input_price_right" type="text"/></div><div class="fl w89 f_timeout"><input class="fl w80" id="input_timeout" type="text"/></div><button class="fl w5" onclick="section.addSymbol()">add</button><div class="cb"></div></div>'},
loadTemplateSymbols:function(){AJAX.create({type:"json",post:JSON.stringify({symbol_template_id:this.id}),url:"http://"+config.qd.host+":"+config.qd.port+"/symbol_templates/symbol/get",success:this.binded_onTemplateSymbolsLoaded})},onTemplateSymbolsLoaded:function(b){if(!b.result.access_denied){for(var b=this.symbols=b.result.symbols,a="",d=0,e=b.length,f=e-1;d<e;d++)var c=b[d],a=a+('<div class="'+(d==f?"last":"")+'row">'),a=a+('<div class="fl w80 cell f_symbol">'+c.symbol+"</div>"),a=a+('<div class="fl w80 cell f_echo_symbol">'+
(c.echo_symbol&&c.echo_symbol.length?c.echo_symbol:"&nbsp;")+"</div>"),a=a+('<div class="fl w80 cell f_factor">'+(c.factor?c.factor:"&nbsp;")+"</div>"),a=a+('<div class="fl w80 cell f_bid_markup">'+(c.bid_markup?c.bid_markup:"&nbsp;")+"</div>"),a=a+('<div class="fl w80 cell f_ask_markup">'+(c.ask_markup?c.ask_markup:"&nbsp;")+"</div>"),a=a+('<div class="fl w80 cell f_price_left">'+(c.price_left?c.price_left:"&nbsp;")+"</div>"),a=a+('<div class="fl w80 cell f_price_right">'+(c.price_right?c.price_right:
"&nbsp;")+"</div>"),a=a+('<div class="fl w80 cell f_timeout">'+(c.timeout?c.timeout:"&nbsp;")+"</div>"),a=a+'<div class="fl w50 lastcell">',a=a+("<a href=\"javascript:section.delSymbol('"+c.symbol+"')\">del</a>"),a=a+"</div>",a=a+'<div class="cb"></div>',a=a+"</div>";cont_symbols.innerHTML=a}},delSymbol:function(b){AJAX.create({type:"json",post:JSON.stringify({symbol_template_id:this.id,symbol:b}),url:"http://"+config.qd.host+":"+config.qd.port+"/symbol_templates/symbol/del",success:this.binded_onSymbolDeleted})},
onSymbolDeleted:function(){this.loadTemplateSymbols()},fieldGroup:{bb:{price_left:!0,price_right:!0,timeout:!0,duration_limit:!0},classic:{factor:!0,timeout:!0,bid_markup:!0,ask_markup:!0},all:{symbol:!0,echo_symbol:!0,factor:!1,timeout:!1,bid_markup:!1,ask_markup:!1,price_left:!1,price_right:!1,duration_limit:!1}},activeGroup:{bb:!0,classic:!0},trigger:function(b){b.classList.toggle("on");var a=(""+b.id).substr(14);b.classList.contains("on")?this.activeGroup[a]=!0:delete this.activeGroup[a];var b=
{},d;for(d in this.fieldGroup.all)b[d]=this.fieldGroup.all[d];for(var e in this.activeGroup)for(d in this.fieldGroup[e])b[d]=!0;for(d in b){e=b[d]?"block":"none";for(var a=document.querySelectorAll(".f_"+d),f=0,c=a.length;f<c;f++)a[f].style.display=e}}});sections.addSection(Sections.TemplatesEdit.create());
TopMenu=Class.inherit({onCreate:function(){},place:function(a){var b=this.render();a.innerHTML=b},render:function(){return'<div><a href="#qservers" class="fl rm5">[ quote servers ]</a><a href="#bridge" class="fl rm5">[ bridge ]</a><a href="#templates/list" class="fl rm5">[ templates ]</a><a href="javascript:auth.logout()" class="fl rm5">[ logout]</a><div class="cb"></div></div>'}});
function onLoad(){topMenu=TopMenu.create();topMenu.place(top_menu);breadCrumbs=BreadCrumbs.create();breadCrumbs.place("#cont_bread_crumbs");auth.init(cont_body);(session_hash=cookie(config.auth.cookie))?sections.start():auth.show()};
